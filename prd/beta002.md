# 🍅 番茄时间 · Mac Menu Bar App

## 版本说明

- **Beta 002** - 包含实现过程中新增的功能
- 基于 Beta 001 需求文档
- 当前状态：开发完成，测试中

---

## 产品定位

一个为个人使用设计的、允许"流氓式强提醒"的执行工具

**核心目标：** 强制你在该休息的时候停下来

**设计理念：** 它不奖励自律，只惩罚不休息

---

## 1. 产品原则（不可违背）

1. 当专注时间结束，系统状态必须切换，而不是询问用户意愿
2. 推迟是一种违规行为，而不是正常操作
3. 强提醒优先于"用户体验上的温柔"
4. 不做复杂任务管理，不做分析报表
5. 一切设计服务于"停止工作 → 去休息"

---

## 2. 核心状态机

### 2.1 状态定义

| 状态 | 说明 | Menu Bar 显示 |
|-----|------|--------------|
| **Idle** | 未开始 | 🍅 |
| **Focus** | 正常番茄专注 | 🍅 MM:SS |
| **Snooze** | 推迟专注（违规阶段） | ⛔ +累计秒s |
| **Break** | 休息阶段 | ☕ MM:SS |

❗ **Snooze 是独立状态，不是 Focus 的一部分**

### 2.2 状态流转（完整版）

```
Idle
├─ Start → Focus
└─ Stop → Idle

Focus
├─ TimeUp → Snooze（推迟选择）
├─ Stop → Idle（手动停止，不计完成）
└─ Pause/Resume（暂停/恢复）

Snooze
├─ TimeUp（次数 < 3）→ 再 Snooze
├─ TimeUp（次数 = 3）→ 强制 Break
├─ StartBreak → Break
└─ Stop → Idle（取消推迟）

Break
├─ TimeUp → Idle
├─ Stop → Idle（提前结束）
└─ Pause/Resume（暂停/恢复）
```

---

## 3. Menu Bar 行为规范

### 3.1 实时倒计时显示

- **Focus / Break 阶段**：实时显示剩余时间（每秒刷新）
- **Snooze 阶段**：显示累计推迟时间
- **Idle**：显示简短标识 🍅

### 3.2 显示格式

- 时间格式：`MM:SS`（使用等宽数字）
- 暂停状态：在状态后显示 `(已暂停)`
- 累计推迟：`⛔ +30s`（测试模式）

### 3.3 菜单结构

| 状态 | 菜单选项 |
|-----|---------|
| **Idle** | 开始番茄钟 / 退出 |
| **Focus** | 暂停（或继续）/ 停止 / 退出 |
| **Snooze** | 开始休息 / 停止 / 退出 |
| **Break** | 暂停（或继续）/ 停止 / 退出 |

---

## 4. 新增功能（Beta 002）

### 4.1 手动停止/打断功能

**需求背景：** 用户希望在任何状态下都能主动中断当前计时

**功能描述：**
- ✅ **Focus 状态**：可停止专注，回到 Idle，**不计入完成数**
- ✅ **Snooze 状态**：可取消推迟，回到 Idle
- ✅ **Break 状态**：可提前结束休息，回到 Idle

**实现细节：**
- 新增 `EventType.STOP` 事件
- 各状态处理器中实现 STOP 事件处理
- 打断的番茄不增加 `completedPomodoros` 计数
- 重置推迟计数器

### 4.2 暂停/恢复功能

**需求背景：** 用户需要临时中断计时，但不希望完全停止

**功能描述：**
- ✅ Focus 和 Break 状态可暂停
- ✅ 暂停时 Menu Bar 显示"继续"选项
- ✅ 状态文本显示 `(已暂停)`
- ✅ 恢复后继续计时

**技术要点：**
- 暂停时保存剩余时间
- 恢复时从剩余时间继续
- 实时获取 context 避免闭包陷阱

### 4.3 数据持久化

**功能描述：**
- ✅ 应用重启后恢复状态
- ✅ 保存：完成番茄数、当前状态、剩余时间
- ✅ 恢复后自动重启计时器

---

## 5. 提醒系统（强制）

### 5.1 提醒形式

- macOS 原生系统级弹窗（`dialog.showMessageBox`）
- 覆盖当前工作窗口
- 不全屏、不锁输入

### 5.2 提醒触发点

| 触发事件 | 是否提醒 |
|---------|---------|
| Focus 完成 | ✅ |
| Snooze 完成 | ✅ |
| Break 完成 | ✅ |

---

## 6. 推迟（Snooze）机制

### 6.1 基本规则

- 番茄专注结束后，允许推迟进入休息
- 每次推迟可选：5 / 10 / 15 秒（测试模式）
- 无论选择哪种时长，均消耗 1 次推迟次数
- 每轮番茄最多允许推迟 3 次
- 推迟时间不计入番茄完成数

### 6.2 推迟强度递增

| 推迟次数 | 弹窗图标 | 行为 |
|---------|---------|------|
| 0 | 🍅 | 中性，可推迟 |
| 1 | ⚠️ | 警告，可推迟 |
| 2 | ⛔ | 最后警告，明确"最后一次" |
| 3 | 🚫 | 强制休息，无选择 |

### 6.3 休息时间计算

**公式：**
```
休息时间 = 基础时间 + floor(累计推迟秒 ÷ 5)
```

**示例（测试模式）：**
- 无推迟：5 秒休息
- 推迟 10 秒：5 + 2 = 7 秒休息
- 推迟 30 秒：5 + 6 = 11 秒休息

---

## 7. 休息阶段行为

- 进入 Break 后，Menu Bar 显示 ☕
- 弹窗提示休息开始
- 休息完成后系统级弹窗提醒
- **不自动开始下一个番茄**

---

## 8. 不做清单（MVP 明确排除）

- ❌ 任务管理
- ❌ 标签 / 项目
- ❌ 统计报表
- ❌ 云同步
- ❌ 网站 / App 封锁
- ❌ 成就系统

---

## 9. 技术实现

### 9.1 技术栈

- **框架**：electron-vite
- **语言**：TypeScript
- **状态管理**：Zustand + 自定义状态机
- **持久化**：electron-store
- **平台**：macOS

### 9.2 项目架构

```
src/
├── main/                     # 主进程
│   ├── index.ts              # 主入口（集成层）
│   ├── state-machine/        # 状态机核心 ⭐
│   │   ├── state-machine.ts
│   │   └── states/
│   │       ├── idle.ts
│   │       ├── focus.ts
│   │       ├── snooze.ts
│   │       └── break.ts
│   ├── timer/                # 精确计时器 ⭐
│   │   └── timer.ts
│   ├── notifications/        # 系统弹窗 ⭐
│   │   └── alert-manager.ts
│   ├── menu-bar/             # Menu Bar ⭐
│   │   ├── tray-manager.ts
│   │   └── title-formatter.ts
│   └── persistence/          # 数据持久化
│       └── store.ts
└── shared/                   # 共享代码
    ├── types.ts              # 类型定义
    ├── constants.ts          # 常量配置
    ├── store.ts              # Zustand store
    └── utils/
        └── time.ts           # 时间工具
```

### 9.3 核心技术要点

**1. 状态机驱动架构**
- 使用 State 模式，每个状态独立处理事件
- 状态转换清晰，避免 if-else 堆砌
- 事件驱动：所有操作通过事件触发

**2. 精确计时器（目标时间法）**
```typescript
// 避免累积误差
const expectedEndTime = Date.now() + duration * 1000
const remaining = Math.max(0, Math.ceil((expectedEndTime - Date.now()) / 1000))
```

**3. 闭包陷阱处理**
```typescript
// ❌ 错误：使用闭包捕获的旧 context
const context = this.stateMachine.getContext()
callback(() => {
  updateUI(context)  // 旧引用
})

// ✅ 正确：实时获取最新 context
callback(() => {
  updateUI(this.stateMachine.getContext())  // 新引用
})
```

---

## 10. 测试模式配置

**当前配置（便于快速测试）：**

| 项目 | 正式模式 | 测试模式 |
|-----|---------|---------|
| 番茄时长 | 25 分钟 | **25 秒** |
| 基础休息 | 5 分钟 | **5 秒** |
| 推迟选项 | 5/10/15 分钟 | **5/10/15 秒** |
| 惩罚计算 | floor(推迟分钟÷5) | **floor(推迟秒÷5)** |

**切换方法：**
修改 `src/shared/constants.ts` 即可

---

## 11. MVP 完成标准

### 11.1 功能完整性

- ✅ Menu Bar 实时显示倒计时
- ✅ 番茄完成必定打断当前工作
- ✅ 推迟机制可用且强度递增
- ✅ 达到最大推迟次数后强制休息
- ✅ 休息时间随违规行为自动增加
- ✅ **手动停止功能（新增）**
- ✅ **暂停/恢复功能（新增）**
- ✅ **数据持久化（新增）**

### 11.2 测试场景

1. **正常流程**：Idle → Focus → Snooze → Break → Idle
2. **推迟流程**：Focus → Snooze(3次) → 强制 Break
3. **打断流程**：任意状态 → Stop → Idle
4. **暂停恢复**：Focus → Pause → Resume → 完成
5. **状态恢复**：应用崩溃后重启，状态正确恢复

---

## 12. 已知问题 & 限制

### 12.1 已解决

- ✅ 无限递归问题（tick 事件循环）
- ✅ 暂停后恢复 Tray 标题不更新（闭包陷阱）
- ✅ 状态恢复时计时器未启动

### 12.2 当前限制

- 仅支持 macOS
- Menu Bar 图标为透明（需添加自定义图标）
- 推迟弹窗使用系统原生样式

---

## 13. 未来规划（非 MVP）

- [ ] 添加自定义 Menu Bar 图标
- [ ] 支持自定义番茄时长
- [ ] 添加声音提醒
- [ ] 跨平台支持（Windows/Linux）
- [ ] 统计功能（每日/每周完成数）

---

## 附录：开发日志

### 重要修复记录

1. **无限递归修复**
   - 问题：`updateTimeLeft` → emit('tick') → onUpdateLeft → 无限循环
   - 解决：移除 'tick' 事件监听器，UI 更新由计时器回调直接处理

2. **暂停恢复修复**
   - 问题：恢复后 Tray 标题不更新
   - 原因：回调使用闭包捕获的旧 context 引用
   - 解决：在回调中实时调用 `this.stateMachine.getContext()`

3. **状态恢复修复**
   - 问题：恢复状态后计时器未启动
   - 解决：在 `restoreState()` 中检测 FOCUS/BREAK 状态并启动计时器

---

**最后一句评价（非常重要的设计理念）：**

> 你这个设计非常自洽，而且有一个很罕见的优点：
>
> **它不奖励自律，只惩罚不休息**
>
> 这对真正的高强度工作者来说，是对的。
